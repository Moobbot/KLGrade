import pandas as pd
import os
import torch
from torch import nn
from torch.utils.data import DataLoader
from torchvision import transforms
from dataset import ImageDataset

test = pd.read_csv('./KneeXray/Test_correct.csv') # _cn _clahe 등, 수정 O, 수정 x -> 결과 비교

transform = transforms.Compose([
                                transforms.ToTensor(),
                                transforms.Normalize([0.5,0.5,0.5],[0.5,0.5,0.5]),
                               ])

test_data = ImageDataset(test, transforms=transform)
testloader = DataLoader(test_data, batch_size=1, shuffle=False)

model_path = './models/'
submission_path = './submission/'
model_list = os.listdir(model_path)
model_list_pt = [file for file in model_list if file.endswith(".pt")]

preds = []
for i in range(1656):
    globals()['max_{}'.format(i)] = []

for i in model_list_pt:
    k = 0
    model_ft = torch.load('{}{}'.format(model_path, i))

    for batch in testloader:
        with torch.no_grad():
            image = batch['image'].cuda()
            output = model_ft(image)
            globals()['max_{}'.format(k)].extend([j.item() for j in torch.argmax(output, axis=1)])
            k = k + 1

for i in range(1656):
    preds.append(max(set(globals()['max_{}'.format(i)]), key=globals()['max_{}'.format(i)].count)) # Hard Voting Ensemble 후 예측 라벨 값을 preds = []에 append

submit = pd.DataFrame({'data':[i.split('/')[-1] for i in test['data']], 'label':preds})

submit.to_csv('{}ensemble_submission.csv'.format(submission_path), index=False)
print('save ensemble_submission.csv')